<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BankTrust | Pay EMI</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-gray-800">

  <!-- TOP NAV -->
  <header class="bg-white shadow-md px-8 py-5 flex justify-between items-center border-b border-slate-200">
    <div class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">BankTrust</div>
    <div class="text-right">
      <p class="font-semibold text-gray-900">Welcome, <%=Customers.username %></p>
      <p class="text-xs text-gray-500 mt-1">Customer ID: <%= Customers.cif %></p>
    </div>
  </header>

  <div class="flex min-h-screen bg-slate-50">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white shadow-lg min-h-screen p-6 border-r border-slate-200">
      <h2 class="font-bold text-gray-900 mb-6 text-lg uppercase tracking-wider text-sm">Navigation</h2>
      <ul class="space-y-2 text-gray-700">
        <li><a href="/" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-100 rounded-lg transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-3m0 0l7-4 7 4M5 9v10a1 1 0 001 1h12a1 1 0 001-1V9m-9 11l4-4m0 0l4 4m-4-4v4m-4-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
          <span class="text-sm font-medium">Dashboard</span></a></li>
        <li><a href="/accounts/<%=id%>" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-100 rounded-lg transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
          <span class="text-sm font-medium">Accounts</span></a></li>
        <li><a href="/upi/<%=id%>" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-100 rounded-lg transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
          <span class="text-sm font-medium">UPI</span></a></li>
        <li><a href="/deposits/<%=id%>" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-100 rounded-lg transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span class="text-sm font-medium">Deposits</span></a></li>
        <li><a href="/loans/<%=id%>" class="flex items-center gap-3 px-4 py-3 bg-blue-50 text-blue-700 rounded-lg font-semibold border-l-4 border-blue-600">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          <span class="text-sm font-medium">Loans</span></a></li>
        <li><a href="/transfers/<%=id%>" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-100 rounded-lg transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 11-8 0 4 4 0 018 0zM15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
          <span class="text-sm font-medium">Transfers</span></a></li>
        <li><a href="/statements/<%=id%>" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-100 rounded-lg transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
          <span class="text-sm font-medium">Statements</span></a></li>
        <li><a href="/profile/<%=id%>" class="flex items-center gap-3 px-4 py-3 hover:bg-slate-100 rounded-lg transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
          <span class="text-sm font-medium">Profile</span></a></li>
        <li><a href="/logout" class="flex items-center gap-3 px-4 py-3 text-red-600 hover:bg-red-50 rounded-lg transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
          <span class="text-sm font-medium">Logout</span></a></li>
      </ul>
      <hr class="my-6 border-slate-200">
      <ul class="text-sm space-y-2">
        <li><a href="#" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
          Block Debit Card</a></li>
        <li><a href="#" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-medium">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
          Report Fraud</a></li>
      </ul>
    </aside>

    <!-- MAIN CONTENT -->
    <!-- MAIN CONTENT -->
<main class="flex-1 p-8 space-y-10">

  <!-- HEADER -->
  <div>
    <h1 class="text-4xl font-bold text-gray-900">Loan EMI Payments</h1>
    <p class="text-gray-600 mt-1">
      EMIs can be paid only within 5 days before due date or if overdue
    </p>
  </div>

  <!-- SUMMARY -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-white p-6 rounded-xl shadow border">
      <p class="text-sm text-gray-500">Total Pending</p>
      <p class="text-2xl font-bold text-red-600">â‚¹<%= TotalPending %></p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow border">
      <p class="text-sm text-gray-500">Overdue Penalty</p>
      <p class="text-2xl font-bold text-orange-600">â‚¹<%= OverduePenalty %></p>
    </div>

    <div class="bg-white p-6 rounded-xl shadow border">
      <p class="text-sm text-gray-500">Account Balance</p>
      <p class="text-2xl font-bold text-green-600">â‚¹<%= AccountBalance %></p>
    </div>
  </div>

  <!-- ================= PAYABLE EMIs ================= -->
  <section class="bg-white p-6 rounded-xl shadow border">
    <h2 class="text-xl font-bold text-gray-900 mb-4">Payable EMIs</h2>

    <% if (PendingEMIs.length === 0) { %>
      <p class="text-gray-500 text-sm">No pending or overdue EMIs ðŸŽ‰</p>
    <% } else { %>

    <table class="w-full text-sm">
      <thead class="bg-slate-50 border-b">
        <tr>
          <th class="p-3 text-left">Due Date</th>
          <th class="p-3 text-left">EMI</th>
          <th class="p-3 text-left">Penalty</th>
          <th class="p-3 text-left">Total</th>
          <th class="p-3 text-left">Status</th>
          <th class="p-3 text-left">Action</th>
        </tr>
      </thead>

      <tbody>
        <% PendingEMIs.forEach(emi => {
          const today = new Date()
          const due = new Date(emi.payout_date)
          const diffDays = Math.ceil((due - today) / (1000 * 60 * 60 * 24))
        %>

        <tr class="border-b hover:bg-slate-50">
          <td class="p-3 font-medium">
            <%= due.toLocaleDateString("en-IN") %>
          </td>

          <td class="p-3">
            â‚¹<%= Number(emi.emi_amount).toLocaleString("en-IN") %>
          </td>

          <td class="p-3 text-red-600">
            â‚¹<%= Number(emi.penalty_amount || 0).toLocaleString("en-IN") %>
          </td>

          <td class="p-3 font-bold text-red-600">
            â‚¹<%= (Number(emi.emi_amount) + Number(emi.penalty_amount || 0)).toLocaleString("en-IN") %>
          </td>

          <td class="p-3">
            <% if (emi.status === "OVERDUE") { %>
              <span class="px-2 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-full">
                OVERDUE
              </span>
            <% } else { %>
              <span class="px-2 py-1 text-xs font-semibold bg-yellow-100 text-yellow-700 rounded-full">
                DUE SOON
              </span>
            <% } %>
          </td>

          <td class="p-3">
            <% if (emi.status === "OVERDUE" || diffDays <= 5) { %>
              <button
                onclick="openPaymentModal(
                  '<%= emi.payout_id %>',
                  '<%= emi.loan_id %>',
                  '<%= emi.linked_account %>',
                  <%= Number(emi.emi_amount) + Number(emi.penalty_amount || 0) %>
                )"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-semibold hover:bg-blue-700">
                Pay Now
              </button>
            <% } else { %>
              <span class="text-xs text-gray-400">
                Available in <%= diffDays - 5 %> days
              </span>
            <% } %>
          </td>
        </tr>

        <% }) %>
      </tbody>
    </table>

    <% } %>
  </section>

  <!-- ================= PAID EMIs ================= -->
  <section class="bg-white p-6 rounded-xl shadow border">
    <h2 class="text-xl font-bold text-gray-900 mb-4">Paid EMIs</h2>

    <% if (!PaidEMIs || PaidEMIs.length === 0) { %>
      <p class="text-gray-500 text-sm">No EMIs paid yet</p>
    <% } else { %>

    <table class="w-full text-sm">
      <thead class="bg-slate-50 border-b">
        <tr>
          <th class="p-3 text-left">Due Date</th>
          <th class="p-3 text-left">Paid On</th>
          <th class="p-3 text-left">Amount</th>
          <th class="p-3 text-left">Status</th>
        </tr>
      </thead>

      <tbody>
        <% PaidEMIs.forEach(emi => { %>
        <tr class="border-b hover:bg-slate-50">
          <td class="p-3">
            <%= new Date(emi.payout_date).toLocaleDateString("en-IN") %>
          </td>

          <td class="p-3">
            <%= new Date(emi.paid_date).toLocaleDateString("en-IN") %>
          </td>

          <td class="p-3 font-semibold text-green-700">
            â‚¹<%= Number(emi.emi_amount).toLocaleString("en-IN") %>
          </td>

          <td class="p-3">
            <span class="px-2 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full">
              PAID
            </span>
          </td>
        </tr>
        <% }) %>
      </tbody>
    </table>

    <% } %>
  </section>

</main>

<!-- ================= PAYMENT MODAL ================= -->
<div id="paymentModal"
     class="hidden fixed inset-0 bg-black/50 backdrop-blur flex items-center justify-center z-50">

  <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl">
    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-5 rounded-t-2xl text-white">
      <h2 class="text-xl font-bold">Confirm EMI Payment</h2>
      <p class="text-xs text-blue-100 mt-1">This action cannot be reversed</p>
    </div>

    <form id="paymentForm" class="p-6 space-y-4">
      <input type="hidden" id="formEmiId">
      <input type="hidden" id="formAccountId">

      <div class="bg-slate-100 p-4 rounded-lg">
        <p class="text-sm text-gray-500">Amount to Pay</p>
        <p id="paymentAmount" class="text-3xl font-extrabold text-gray-900">â‚¹0</p>
      </div>

      <label class="flex items-start gap-3 text-sm">
        <input type="checkbox" id="confirmCheckbox" class="mt-1 accent-blue-600">
        <span>I confirm this EMI payment.</span>
      </label>

      <div class="flex gap-3">
        <button type="button"
                onclick="closePaymentModal()"
                class="flex-1 py-2 bg-slate-200 rounded-lg font-semibold">
          Cancel
        </button>

        <button id="payBtn"
                type="submit"
                class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">
          Pay EMI
        </button>
      </div>
    </form>

    <p class="text-xs text-center text-gray-500 pb-4">
      ðŸ”’ Secured with bank-grade encryption
    </p>
  </div>
</div>

<script>
function openPaymentModal(payoutId, loanId, accountId, amount) {
  document.getElementById("formEmiId").value = payoutId
  document.getElementById("formAccountId").value = accountId
  document.getElementById("paymentAmount").innerText =
    "â‚¹" + amount.toLocaleString("en-IN")
  document.getElementById("paymentForm").action =
    `/pay-emi/<%= id %>/${loanId}`
  document.getElementById("confirmCheckbox").checked = false
  document.getElementById("paymentModal").classList.remove("hidden")
}

function closePaymentModal() {
  document.getElementById("paymentModal").classList.add("hidden")
}

document.getElementById("paymentForm").addEventListener("submit", async e => {
  e.preventDefault()
  if (!confirmCheckbox.checked) return alert("Confirm payment")

  payBtn.disabled = true
  payBtn.innerText = "Processing..."

  const res = await fetch(e.target.action, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      payout_id: formEmiId.value,
      account_id: formAccountId.value
    })
  })

  const data = await res.json()

  if (res.ok) {
    window.location.reload()
  } else {
    alert(data.error)
    payBtn.disabled = false
    payBtn.innerText = "Pay EMI"
  }
})
</script>
